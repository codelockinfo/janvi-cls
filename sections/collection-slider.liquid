{{ 'collection-slider.css' | asset_url | stylesheet_tag }}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

{%- style -%}
  .collection-slider-section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .collection-slider-section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

{%- liquid      
  if section.settings.collection.all_products_count > section.settings.products_to_show       
    assign more_in_collection = true
  endif
-%}

<div class="collection-slider-section-{{ section.id }}-padding gradient color-{{ section.settings.color_scheme }}">
  <div class="collection-slider {% if section.settings.full_width == false %} custom-page-width {% endif %}">
    <div class="collection-slider__text">
      {% if section.settings.heading != blank %}
        <h2 class="collection-slider__heading {{ section.settings.heading_size }}">
          {{ section.settings.heading }}
        </h2>
      {% endif %}

      {%- if section.settings.description != blank
        or section.settings.show_description
        and section.settings.collection.description != empty
      -%}
        <div class="collection__description {{ section.settings.description_style }}">
          {%- if section.settings.show_description -%}
            {{ section.settings.collection.description }}
          {%- else -%}
            {{ section.settings.description -}}
          {%- endif %}
        </div>
      {%- endif -%}
    </div>

    <div class="hide-mobile">
      {% if section.settings.enable_desktop_slider %}     
        <div class="swiper myswiper">
          <div class="swiper-wrapper">    
            {% for product in section.settings.collection.products limit: section.settings.products_to_show %}
              <div class="swiper-slide">
                <div class="product-card">
                  <a href="{{ product.url }}" class="product-card__link">
                    <div class="product-card__image-wrapper product-card__image-wrapper--{{ section.settings.image_ratio }} product-card__image-wrapper--{{ section.settings.image_shape }} {% if section.settings.show_secondary_image %} product-card__image-hover {% endif %}">
                      {% if product.featured_image != blank %}
                        <img src="{{ product.featured_image | image_url: width: 500 }}" alt="{{ product.featured_image.alt | escape }}" class="product-card__image product-card__image--primary" />
                        {% if section.settings.show_secondary_image == true and product.images.size > 1 %}
                          <img src="{{ product.images[1] | image_url: width: 500 }}" alt="{{ product.images[1].alt | escape }}" class="product-card__image product-card__image--secondary" />
                        {% endif %}
                      {% else %}
                        {{ 'product-apparel-1' | placeholder_svg_tag: 'placeholder-svg' }}
                      {% endif %}
                    </div>

                    <div class="product-card__info">
                      <p class="product-card__title">{{ product.title }}</p>
                      {% if section.settings.show_vendor %}
                        <p class="product-card__vendor">{{ product.vendor }}</p>
                      {% endif %}
                      <span class="product-card__price">
                        {{ product.price | money }}
                      </span>
                    </div>
                  </a>
                  {% if section.settings.quick_add == 'standard'%}
                    {% if product.variants.size > 1 %}
                      <a class="button" href="{{ product.url }}">Choose options</a>
                    {% else %}
                      <form method="post" action="/cart/add">
                        <input type="hidden" name="id" value="{{ product.variants.first.id }}">
                        <button type="submit" class="button">Add to cart</button>
                        </form>                  
                      {% endif %}
                  {% endif %}

                  {% if section.settings.quick_add == 'bulk'%}
                    {% if product.variants.size > 1 %}
                      <a class="button" href="{{ product.url }}">Choose options</a>
                    {% else %}
                      <div class="bulk-quantity" data-product-id="{{ product.variants.first.id }}">
                        <button type="button" class="qty-btn minus">-</button>
                        <span class="qty-display" id="qty-{{ product.variants.first.id }}">0</span>
                        <button type="button" class="qty-btn plus">+</button>
                      </div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
          <div class="swiper-button-prev"> </div>
          <div class="swiper-button-next"> </div>
        </div>
      {% else %}
        <div class="products-grid grid--{{ section.settings.columns_desktop }}-cols grid--{{ section.settings.columns_mobile }}-cols">
          {% for product in section.settings.collection.products limit: section.settings.products_to_show %}
            <div class="product-card">
              <a href="{{ product.url }}" class="product-card__link">
                <div class="product-card__image-wrapper product-card__image-wrapper--{{ section.settings.image_ratio }} product-card__image-wrapper--{{ section.settings.image_shape }} product-card__image-wrapper--{{ section.settings.show_secondary_image }}">
                  {% if product.featured_image != blank %}
                    <img src="{{ product.featured_image | image_url: width: 500 }}" alt="{{ product.featured_image.alt | escape }}" class="product-card__image product-card__image--primary" />
                    {% if section.settings.show_secondary_image == true and product.images.size > 1 %}
                      <img src="{{ product.images[1] | image_url: width: 500 }}" alt="{{ product.images[1].alt | escape }}" class="product-card__image product-card__image--secondary" />
                    {% endif %}
                  {% else %}
                    {{ 'product-apparel-1' | placeholder_svg_tag: 'placeholder-svg' }}
                  {% endif %}
                </div>

                <div class="product-card__info">
                  <p class="product-card__title">{{ product.title }}</p>
                  {% if section.settings.show_vendor %}
                    <p class="product-card__vendor">{{ product.vendor }}</p>
                  {% endif %}
                  <span class="product-card__price">{{ product.price | money }}</span>
                </div>
              </a>
              {% if section.settings.quick_add == 'standard'%}
                    {% if product.variants.size > 1 %}
                      <a class="button" href="{{ product.url }}">Choose options</a>
                    {% else %}
                      <form method="post" action="/cart/add">
                        <input type="hidden" name="id" value="{{ product.variants.first.id }}">
                        <button type="submit" class="button">Add to cart</button>
                        </form>                  
                      {% endif %}
                  {% endif %}
                  
                  {% if section.settings.quick_add == 'bulk'%}
                    {% if product.variants.size > 1 %}
                      <a class="button" href="{{ product.url }}">Choose options</a>
                    {% else %}
                      <div class="bulk-quantity" data-product-id="{{ product.variants.first.id }}">
                        <button type="button" class="qty-btn minus">-</button>
                        <span class="qty-display" id="qty-{{ product.variants.first.id }}">0</span>
                        <button type="button" class="qty-btn plus">+</button>
                      </div>
                    {% endif %}
                  {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="hide-desktop">
      {% if section.settings.swipe_on_mobile %}     
        <div class="swiper myswiper">
          <div class="swiper-wrapper">    
            {% for product in section.settings.collection.products limit: section.settings.products_to_show %}
              <div class="swiper-slide">
                <div class="product-card">
                  <a href="{{ product.url }}" class="product-card__link">
                    <div class="product-card__image-wrapper product-card__image-wrapper--{{ section.settings.image_ratio }} product-card__image-wrapper--{{ section.settings.image_shape }} {% if section.settings.show_secondary_image %} product-card__image-hover {% endif %}">
                      {% if product.featured_image != blank %}
                        <img src="{{ product.featured_image | image_url: width: 500 }}" alt="{{ product.featured_image.alt | escape }}" class="product-card__image product-card__image--primary" />
                        {% if section.settings.show_secondary_image == true and product.images.size > 1 %}
                          <img src="{{ product.images[1] | image_url: width: 500 }}" alt="{{ product.images[1].alt | escape }}" class="product-card__image product-card__image--secondary" />
                        {% endif %}
                      {% else %}
                        {{ 'product-apparel-1' | placeholder_svg_tag: 'placeholder-svg' }}
                      {% endif %}
                    </div>

                    <div class="product-card__info">
                      <p class="product-card__title">{{ product.title }}</p>
                      {% if section.settings.show_vendor %}
                        <p class="product-card__vendor">{{ product.vendor }}</p>
                      {% endif %}
                      <span class="product-card__price">
                        {{ product.price | money }}
                      </span>
                    </div>
                  </a>
                  {% if section.settings.quick_add == 'standard'%}
                    {% if product.variants.size > 1 %}
                      <a class="button" href="{{ product.url }}">Choose options</a>
                    {% else %}
                      <form method="post" action="/cart/add">
                        <input type="hidden" name="id" value="{{ product.variants.first.id }}">
                        <button type="submit" class="button">Add to cart</button>
                      </form>                  
                    {% endif %}
                  {% endif %}

                  {% if section.settings.quick_add == 'bulk'%}
                    {% if product.variants.size > 1 %}
                      <a class="button" href="{{ product.url }}">Choose options</a>
                    {% else %}
                      <div class="bulk-quantity" data-product-id="{{ product.variants.first.id }}">
                        <button type="button" class="qty-btn minus">-</button>
                        <span class="qty-display" id="qty-{{ product.variants.first.id }}">0</span>
                        <button type="button" class="qty-btn plus">+</button>
                      </div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
          <div class="swiper-button-prev"> </div>
          <div class="swiper-button-next"> </div>
        </div>
      {% else %}
        <div class="products-grid grid--{{ section.settings.columns_desktop }}-cols grid--{{ section.settings.columns_mobile }}-cols">
          {% for product in section.settings.collection.products limit: section.settings.products_to_show %}
            <div class="product-card">
              <a href="{{ product.url }}" class="product-card__link">
                <div class="product-card__image-wrapper product-card__image-wrapper--{{ section.settings.image_ratio }} product-card__image-wrapper--{{ section.settings.image_shape }} product-card__image-wrapper--{{ section.settings.show_secondary_image }}">
                  {% if product.featured_image != blank %}
                    <img src="{{ product.featured_image | image_url: width: 500 }}" alt="{{ product.featured_image.alt | escape }}" class="product-card__image product-card__image--primary" />
                    {% if section.settings.show_secondary_image == true and product.images.size > 1 %}
                      <img src="{{ product.images[1] | image_url: width: 500 }}" alt="{{ product.images[1].alt | escape }}" class="product-card__image product-card__image--secondary" />
                    {% endif %}
                  {% else %}
                    {{ 'product-apparel-1' | placeholder_svg_tag: 'placeholder-svg' }}
                  {% endif %}
                </div>

                <div class="product-card__info">
                  <p class="product-card__title">{{ product.title }}</p>
                  {% if section.settings.show_vendor %}
                    <p class="product-card__vendor">{{ product.vendor }}</p>
                  {% endif %}
                  <span class="product-card__price">{{ product.price | money }}</span>
                </div>
              </a>
              {% if section.settings.quick_add == 'standard'%}
                {% if product.variants.size > 1 %}
                  <a class="button" href="{{ product.url }}">Choose options</a>
                {% else %}
                  <form method="post" action="/cart/add">
                    <input type="hidden" name="id" value="{{ product.variants.first.id }}">
                    <button type="submit" class="button">Add to cart</button>
                  </form>                  
                {% endif %}
              {% endif %}
                  
              {% if section.settings.quick_add == 'bulk'%}
                {% if product.variants.size > 1 %}
                  <a class="button" href="{{ product.url }}">Choose options</a>
                {% else %}
                  <div class="bulk-quantity" data-product-id="{{ product.variants.first.id }}">
                    <button type="button" class="qty-btn minus">-</button>
                    <span class="qty-display" id="qty-{{ product.variants.first.id }}">0</span>
                    <button type="button" class="qty-btn plus">+</button>
                  </div>
                {% endif %}
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</div>


{% if section.settings.show_view_all and more_in_collection %}
  <div class="center collection__view-all">
    <a href="{{ section.settings.collection.url }}" class="{% if section.settings.view_all_style == 'link' %}link underlined-link{% elsif section.settings.view_all_style == 'solid' %}button{% else %}button button--secondary{% endif %}">
      {{ 'sections.featured_collection.view_all' | t }}
    </a>
  </div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // 1. Swiper
  new Swiper(".myswiper", {
    navigation: {
      nextEl: ".swiper-button-next",
      prevEl: ".swiper-button-prev"
    },
    pagination: {
      el: ".swiper-pagination",
      clickable: true,
    },
    breakpoints: {
      0: {
        slidesPerView: 2.2,
        spaceBetween: 4,
      },
      750: {
        slidesPerView: 4.3,
        spaceBetween: 8,
      }
    }
  });

  // 2. Store local bulk-quantity state
  const bulkProducts = {};

  // 3. Fetch current cart and sync UI
  function syncCartQuantities() {
    fetch('/cart.js')
      .then(res => res.json())
      .then(cart => {
        cart.items.forEach(item => {
          const variantId = item.variant_id;
          const qty = item.quantity;
          const display = document.querySelector(`.bulk-quantity[data-product-id="${variantId}"] .qty-display`);

          if (display) {
            display.textContent = qty;
            bulkProducts[variantId] = qty;
          }
        });

        updateCartBubble(cart.item_count);
      });
  }

  // 4. Update cart count bubble (optional)
  function updateCartBubble(count) {
    const bubble = document.querySelector('.cart-count-bubble');
    if (bubble) {
      bubble.textContent = count;
    }
  }

  // 5. Add 1 to cart and update display
  function addOneToCart(variantId) {
    fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        items: [{ id: variantId, quantity: 1 }]
      })
    })
    .then(res => res.json())
    .then(data => {
      bulkProducts[variantId] = (bulkProducts[variantId] || 0) + 1;
      document.querySelector(`.bulk-quantity[data-product-id="${variantId}"] .qty-display`).textContent = bulkProducts[variantId];
      syncCartQuantities();
    })
    .catch(err => console.error('Add error:', err));
  }

  // 6. Remove 1 from cart and update display
  function removeOneFromCart(variantId) {
    if (!bulkProducts[variantId] || bulkProducts[variantId] <= 0) return;

    const newQty = bulkProducts[variantId] - 1;

    fetch('/cart/change.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        id: variantId,
        quantity: newQty
      })
    })
    .then(() => {
      bulkProducts[variantId] = newQty;
      document.querySelector(`.bulk-quantity[data-product-id="${variantId}"] .qty-display`).textContent = newQty;
      syncCartQuantities();
    })
    .catch(err => console.error('Remove error:', err));
  }

  // 7. Setup +/â€“ buttons
  document.querySelectorAll('.bulk-quantity').forEach(bulkWrapper => {
    const variantId = bulkWrapper.dataset.productId;
    const plusBtn = bulkWrapper.querySelector('.qty-btn.plus');
    const minusBtn = bulkWrapper.querySelector('.qty-btn.minus');

    plusBtn.addEventListener('click', () => addOneToCart(variantId));
    minusBtn.addEventListener('click', () => removeOneFromCart(variantId));
  });

  // 8. Initial sync
  syncCartQuantities();
});
</script>





{% schema %}
  {
    "name": "Collection Slider",
    "class": "collection-slider-section",
    "tag": "section",
    "settings": [
        {
            "type": "collection",
            "id" : "collection",
            "label": "Collecetion"
        },
        {
            "type": "range",
            "id": "products_to_show",
            "min": 2,
            "max": 25,
            "step": 1,
            "label": "Product Count",
            "default": 4
        },
        {
            "type": "header",
            "content": "Text"
        },
        {
            "type": "inline_richtext",
            "id": "heading",
            "label": "Heading",
            "default": "Heading"
        },
        {
            "type": "select",
            "id": "heading_size",
            "options": [
                {"label": "Small", "value": "h2"},
                {"label": "Medium", "value": "h1"},
                {"label": "Large", "value": "h0"},
                {"label": "Extra large", "value": "hxl"},
                {"label": "Extra extra large", "value": "hxxl"}
            ],
            "label": "Heading Size",
            "default": "h1"
        },
        {
            "type": "richtext",
            "id": "description",
            "label": "Description"
        },
        {
            "type": "checkbox",
            "id": "show_description",
            "label": "Show collection description from admin",
            "default": false
        },
        {
            "type": "select",
            "id": "description_style",
            "options": [
                {"label": "Body", "value": "body"},
                {"label": "Subtitle", "value": "subtitle"},
                {"label": "Upper case", "value": "uppercase"}
            ],
            "label": "Description Style",
            "default": "body"
        },
        {
            "type": "header",
            "content": "Collection Layout"
        },
        {
            "type": "range",
            "id": "columns_desktop",
            "min": 1,
            "max": 6,
            "step": 1,
            "label": "Columns",
            "default": 3
        },
        {
            "type": "checkbox",
            "id": "enable_desktop_slider",
            "label": "Carousel",
            "default": false
        },
        {
            "type": "checkbox",
            "id": "full_width",
            "label": "Full width products",
            "default": false
        },
        {
            "type": "checkbox",
            "id": "show_view_all",
            "label": "'View all' button",
            "default": true
        },
        {
            "type": "select",
            "id": "view_all_style",
            "options": [
                {"label": "Link", "value": "link"},
                {"label": "Outline Button", "value": "outline"},
                {"label": "Solid Button", "value": "solid"}
            ],
            "label": "'View all' style",
            "default": "solid"
        },
        {
            "type": "color_scheme",
            "id": "color_scheme",
            "label": "Color scheme",
            "default": "scheme_1"
        },
        {
            "type": "header",
            "content": "Product card"
        },
        {
            "type": "select",
            "id": "image_ratio",
            "options": [
                {"label": "Adapt to image", "value": "adapt"},
                {"label": "Portrait", "value": "portrait"},
                {"label": "Square", "value": "square"}
            ],
            "label": "Image ratio",
            "default": "adapt"
        },
        {
            "type": "select",
            "id": "image_shape",
            "options": [
                {"label": "Default", "value": "default"},
                {"label": "Arch", "value": "arch"},
                {"label": "Blob", "value": "blob"},
                {"label": "Chevron left", "value": "chevronleft"},
                {"label": "Chevron Right", "value": "chevronright"},
                {"label": "Diamond", "value": "diamond"},
                {"label": "Parallelogram", "value": "parallelogram"},
                {"label": "Round", "value": "round"}
            ],
            "label": "Image shape",
            "default": "default"
        },
        {
            "type": "checkbox",
            "id": "show_secondary_image",
            "label": "Show second image in hover",
            "default": false
        },
        {
            "type": "checkbox",
            "id": "show_vendor",
            "label": "Vendor",
            "default": false
        },
        {
            "type": "checkbox",
            "id": "show_rating",
            "label": "Product rating",
            "default": false
        },
        {
            "type": "select",
            "id": "quick_add",
            "options": [
                {"label": "None", "value": "none"},
                {"label": "Standard", "value": "standard"},
                {"label": "Bulk", "value": "bulk"}
            ],
            "label": "Quick add",
            "default": "none"
        },
        {
            "type": "header",
            "content": "Mobile layout"
        },
        {
            "type": "select",
            "id": "columns_mobile",
            "options": [
                {"label": "1", "value": "1"},
                {"label": "2", "value": "2"}
            ],
            "label": "Columns",
            "default": "2"
        },
        {
            "type": "checkbox",
            "id": "swipe_on_mobile",
            "label": "Carousel",
            "default": false
        },
        {
            "type": "header",
            "content": "Padding"
        },
        {
            "type": "range",
            "id": "padding_top",
            "min": 0,
            "max": 100,
            "step": 4,
            "unit": "px",
            "label": "Top",
            "default":36
        },
        {
            "type": "range",
            "id": "padding_bottom",
            "min": 0,
            "max": 100,
            "step": 4,
            "unit": "px",
            "label": "Bottom",
            "default":36
        }
    ],
    "presets": [
        {
            "name": "Collection Slider"
        }
    ]
  }
{% endschema %}